#!/usr/bin/env node

require('dotenv').config({silent: true})

const fs = require('fs')
const loadDatabase = require('../lib/load-database')
const retrieveLegacyRedirects = require('../lib/build/retrieve-legacy-redirects')
const retrieveHomePage = require('../lib/build/retrieve-home-page')
const retrieveContentPages = require('../lib/build/retrieve-content-pages')
const renderPages = require('../lib/build/render-pages')

function initConfig () {
  const basePath = fs.realpathSync('./')
  const publicPath = `${basePath}/public`
  const databasePath = `${publicPath}/content/db.json`

  return {
    config: {
      env: process.env.NODE_ENV,
      baseUrl: process.env.BASE_URL,
      gaTrackingCode: process.env.GA_TRACKING_CODE,
      googleMapsApiKey: process.env.GOOGLE_MAPS_API_KEY,
      basePath: basePath,
      publicPath: `${basePath}/public`,
      sitePath: `${basePath}/site`,
      databasePath: databasePath
    }
  }
}

function report (e) {
  console.log(`Build ${Object.keys(e.pages).length} pages`)

  return e
}

function build () {
  return Promise.resolve()
    .then(initConfig)
    .then(loadDatabase)
    .then(retrieveLegacyRedirects)
    .then(retrieveHomePage)
    .then(retrieveContentPages)
    .then(renderPages)
    .then(report)
    .catch(err => { console.log(err); process.exit(1) })
}

build()
