box: wercker/ruby
build:
  steps:
    - arjen/hugo-build:
        version: 0.13
    - script:
        code: rsync -avpr images public/
    - kyleboyle/html-proofer-test:
        version: "2.2.0"
        basedir: public
        arguments: --checks-to-ignore ImageCheck --verbose
  after-steps:
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_TOKEN
deploy:
  steps:
    - arjen/hugo-build:
        version: 0.13
        flags: $HUGO_FLAGS
    - script:
        code: rsync -avpr images public/
    - script:
        code: >
          if [ "$WERCKER_DEPLOYTARGET_NAME" != "production" ]; then
          echo -e "User-agent: *\nDisallow: /\n" > public/robots.txt;
          fi;
    - script:
        code: >
          if [ -f public/404/index.html ]; then
          mv public/404/index.html public/404.html && rmdir public/404;
          fi;
    - leipert/git-push:
        gh_oauth: $GH_TOKEN
        repo: $TARGET_REPO
        branch: $TARGET_BRANCH
        basedir: public
        discard_history: $TARGET_DISCARD_HISTORY
        gh_pages_domain: $MAIN_DOMAIN
  after-steps:
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_TOKEN
